# Railway deploy workflow (template)
# Usage:
# - Add repository secret RAILWAY_API_TOKEN (your Railway API key)
# - Add repository secret RAILWAY_PROJECT_ID (the Railway project id)
# - Optionally add RAILWAY_ENV (eg: production)
# - Set RAILWAY_SERVICE to the service name defined in your Railway project (eg: backend)
# This workflow runs on push to main and will use the Railway CLI to build & deploy the service.

name: Deploy to Railway

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      service:
        description: 'Railway service to deploy (overrides RAILWAY_SERVICE)'
        required: false
        default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Authenticate to Railway
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: |
          set -eux
          if [ -z "$RAILWAY_API_TOKEN" ]; then
            echo "RAILWAY_API_TOKEN is not set. Add it to repository secrets."; exit 1
          fi
          railway login --apiKey "$RAILWAY_API_TOKEN"

      - name: Configure project and service
        id: cfg
        run: |
          set -eux
          # prefer workflow_dispatch input, fallback to repo secrets
          SERVICE_INPUT="${{ github.event.inputs.service }}"
          RAILWAY_SERVICE="${SERVICE_INPUT:-${{ secrets.RAILWAY_SERVICE }}}"
          RAILWAY_PROJECT_ID="${{ secrets.RAILWAY_PROJECT_ID }}"
          if [ -z "$RAILWAY_SERVICE" ]; then
            echo "RAILWAY_SERVICE is not set (either pass as input or add secret)."; exit 1
          fi
          if [ -z "$RAILWAY_PROJECT_ID" ]; then
            echo "RAILWAY_PROJECT_ID not set in secrets."; exit 1
          fi
          echo "service=$RAILWAY_SERVICE" >> $GITHUB_OUTPUT
          echo "project=$RAILWAY_PROJECT_ID" >> $GITHUB_OUTPUT

      - name: Deploy service to Railway
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
          RAILWAY_PROJECT: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_ENV: ${{ secrets.RAILWAY_ENV }}
        run: |
          set -eux
          # Link repository to project (non-interactive); will create a local .railway if needed
          railway link --projectId "$RAILWAY_PROJECT" || true
          # Deploy the specified service (the CLI will build using the service's Dockerfile if present)
          SERVICE_TO_DEPLOY="${{ steps.cfg.outputs.service }}"
          echo "Deploying service: $SERVICE_TO_DEPLOY to project $RAILWAY_PROJECT"
          # Use 'railway up' to build & deploy; --detach to not tail logs
          railway up --service "$SERVICE_TO_DEPLOY" --detach
      - name: Run DB Migration
        if: matrix.service == 'backend'
        run: |
          railway run --service backend npx sequelize db:migrate
